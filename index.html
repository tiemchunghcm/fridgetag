<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>MÃ´ phá»ng Fridge-tag 2E â€“ DÃ¢y chuyá»n láº¡nh</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #eef3ff;
      margin: 0;
      padding: 16px;
      display: flex;
      justify-content: center;
    }
    .app {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.2);
      padding: 20px 24px 24px;
      max-width: 780px;
      width: 100%;
    }
    h1 {
      margin: 0 0 4px;
      font-size: 22px;
      text-align: center;
    }
    .subtitle {
      text-align: center;
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 16px;
    }
    .tag-line {
      text-align: center;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
      margin-bottom: 12px;
    }

    /* VÃ¹ng mÃ´ phá»ng thiáº¿t bá»‹ */
    .device {
      background: #111827;
      border-radius: 18px;
      padding: 16px 18px;
      color: #e5e7eb;
      display: grid;
      grid-template-columns: 1.5fr 1.2fr;
      gap: 14px;
      position: relative;
      margin-bottom: 14px;
    }
    .device.beating {
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.85);
    }
    .device-main {
      border-right: 1px solid rgba(156, 163, 175, 0.3);
      padding-right: 12px;
    }
    .device-side {
      font-size: 12px;
      line-height: 1.5;
    }
    .screen-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .screen-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .temp-row {
      display: flex;
      align-items: baseline;
      gap: 4px;
      margin-bottom: 4px;
    }
    .temp-value {
      font-size: 42px;
      font-weight: 600;
    }
    .temp-unit {
      font-size: 16px;
      opacity: 0.8;
    }
    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 8px;
    }
    .status-chip {
      border-radius: 999px;
      padding: 2px 9px;
      font-size: 11px;
      font-weight: 600;
      border: 1px solid;
    }
    .status-ok {
      background: #16a34a22;
      border-color: #22c55e;
      color: #bbf7d0;
    }
    .status-alarm {
      background: #b91c1c22;
      border-color: #f87171;
      color: #fecaca;
    }
    .status-muted {
      background: #4b556322;
      border-color: #9ca3af;
      color: #d1d5db;
    }
    .time-line {
      font-size: 11px;
      color: #d1d5db;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }
    .time-line span strong {
      color: #f9fafb;
    }

    .side-section {
      margin-bottom: 6px;
    }
    .side-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #9ca3af;
      margin-bottom: 2px;
    }
    .side-text {
      font-size: 12px;
      color: #e5e7eb;
    }
    .side-text small {
      color: #9ca3af;
      font-size: 11px;
    }

    .badge {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 10px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      margin-left: 6px;
    }

    /* Overlay kÃ­ch hoáº¡t */
    .overlay {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.92);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      padding: 12px;
      text-align: center;
    }
    .overlay-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .overlay-text {
      font-size: 12px;
      color: #d1d5db;
      margin-bottom: 10px;
    }
    .overlay-options {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 8px;
    }
    .overlay button {
      background: #1f2937;
      border-radius: 999px;
      border: 1px solid #4b5563;
      color: #f9fafb;
      font-size: 12px;
      padding: 6px 10px;
      cursor: pointer;
    }
    .overlay button:hover {
      background: #374151;
    }

    /* Panel Ä‘iá»u khiá»ƒn */
    .panel {
      background: #f9fafb;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
      margin-bottom: 10px;
    }
    .panel-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .panel-desc {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 4px;
    }
    button {
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      background: #edf2ff;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.15s, transform 0.05s, box-shadow 0.15s;
    }
    button:hover {
      background: #dbe4ff;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .btn-primary {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }
    .btn-primary:hover {
      background: #1d4ed8;
    }
    .btn-warning {
      background: #fef3c7;
      border-color: #facc15;
      color: #92400e;
    }
    .btn-danger {
      background: #fee2e2;
      border-color: #fecaca;
      color: #b91c1c;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 10px;
    }

    .note {
      font-size: 11px;
      color: #6b7280;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>MÃ´ phá»ng Fridge-tag 2E</h1>
    <div class="tag-line">Táº¬P HUáº¤N DÃ‚Y CHUYá»€N Láº NH â€“ CÃ€I Äáº¶T â€¢ Äá»ŒC NHIá»†T Äá»˜ â€¢ Xá»¬ TRÃ BÃO Äá»˜NG</div>
    <div class="subtitle">
      Chia sáº» mÃ n hÃ¬nh cho há»c viÃªn: yÃªu cáº§u Ä‘á»c mÃ n hÃ¬nh, mÃ´ táº£ cÃ¡ch xá»­ trÃ­ váº¯c xin, sau Ä‘Ã³ má»›i báº¥m nÃºt <strong>OK</strong>.
    </div>

    <!-- Thiáº¿t bá»‹ Fridge-tag 2E -->
    <div class="device" id="device">
      <!-- Overlay kÃ­ch hoáº¡t -->
      <div class="overlay" id="overlay">
        <div class="overlay-title">KÃ­ch hoáº¡t láº§n Ä‘áº§u (SET + READ)</div>
        <div class="overlay-text">
          Fridge-tag 2E Ä‘ang á»Ÿ cháº¿ Ä‘á»™ <strong>sleep</strong>. <br />
          Nháº¥n nÃºt bÃªn dÆ°á»›i Ä‘á»ƒ mÃ´ phá»ng nháº¥n <strong>SET + READ &gt; 3 giÃ¢y</strong>, sau Ä‘Ã³ chá»n Ä‘á»‹nh dáº¡ng ngÃ y.
        </div>
        <div class="overlay-options">
          <button id="btnActivateDdMm">SET + READ â†’ dd.mm.yyyy</button>
          <button id="btnActivateMmDd">SET + READ â†’ mm.dd.yyyy</button>
        </div>
        <div class="overlay-text" style="font-size: 11px; color: #9ca3af;">
          Gá»£i Ã½ khi dáº¡y: yÃªu cáº§u há»c viÃªn nháº¯c láº¡i cÃ¡c bÆ°á»›c kÃ­ch hoáº¡t, cÃ i ngÃ y giá» vÃ  ghi chÃº ngÃ y kÃ­ch hoáº¡t lÃªn máº·t sau thiáº¿t bá»‹.
        </div>
      </div>

      <!-- MÃ n chÃ­nh (bÃªn trÃ¡i) -->
      <div class="device-main">
        <div class="screen-label">MÃ n hÃ¬nh</div>
        <div class="screen-title" id="screenTitle">MÃ n hÃ¬nh chÃ­nh â€“ Nhiá»‡t Ä‘á»™ hiá»‡n táº¡i</div>

        <div class="temp-row">
          <span class="temp-value" id="tempValue">5.0</span>
          <span class="temp-unit">Â°C</span>
        </div>

        <div class="status-bar">
          <div>
            <span id="statusChip" class="status-chip status-ok">OK</span>
          </div>
          <div style="font-size: 11px; color: #9ca3af;">
            NgÃ y: <span id="dateDisplay">--/--/----</span>
          </div>
        </div>

        <div class="time-line">
          <span>Tá»•ng thá»i gian cháº¡y: <strong id="totalTime">00:00</strong></span>
          <span>Cháº¿ Ä‘á»™: <strong>1 giÃ¢y = 10 phÃºt</strong></span>
        </div>
        <div class="time-line">
          <span>&gt; 8Â°C (cá»™ng dá»“n): <strong id="highOor">0 phÃºt</strong></span>
          <span>&lt; 2Â°C (cá»™ng dá»“n): <strong id="lowOor">0 phÃºt</strong></span>
        </div>
      </div>

      <!-- BÃªn pháº£i: thÃ´ng tin chi tiáº¿t -->
      <div class="device-side">
        <div class="side-section">
          <div class="side-label">Tráº¡ng thÃ¡i</div>
          <div class="side-text" id="statusText">
            Thiáº¿t bá»‹ Ä‘Ã£ kÃ­ch hoáº¡t, Ä‘ang trong dáº£i an toÃ n <strong>2â€“8Â°C</strong>.
          </div>
        </div>

        <div class="side-section">
          <div class="side-label">
            BÃ¡o Ä‘á»™ng
            <span class="badge" id="alarmBadge">KhÃ´ng cÃ³</span>
          </div>
          <div class="side-text" id="alarmText">
            KhÃ´ng cÃ³ bÃ¡o Ä‘á»™ng. <small>Há»c viÃªn Ä‘á»c mÃ n hÃ¬nh: â€œOK, 5.0 Â°C, náº±m trong vÃ¹ng an toÃ nâ€.</small>
          </div>
        </div>

        <div class="side-section" id="historyBlock">
          <div class="side-label">MÃ n hÃ¬nh READ</div>
          <div class="side-text" id="historyText">
            Báº¥m nÃºt <strong>READ</strong> Ä‘á»ƒ láº§n lÆ°á»£t xem:<br />
            â€“ HÃ´m nay: min / max, cÃ³ alarm khÃ´ng<br />
            â€“ NgÃ y -1: min / max, cÃ³ alarm khÃ´ng<br />
            â€“ Chi tiáº¿t alarm gáº§n nháº¥t (ngÃ y â€“ giá», thá»i lÆ°á»£ng, loáº¡i HIGH/LOW).
          </div>
        </div>
      </div>
    </div>

    <!-- Äiá»u khiá»ƒn giá»‘ng thiáº¿t bá»‹ -->
    <div class="panel">
      <div class="panel-title">CÃ¡c nÃºt trÃªn Fridge-tag 2E (mÃ´ phá»ng)</div>
      <div class="panel-desc">
        DÃ¹ng trong Zoom/Meet: má»i há»c viÃªn yÃªu cáº§u thao tÃ¡c (báº¥m READ bao nhiÃªu láº§n, khi nÃ o báº¥m OKâ€¦).
      </div>
      <div class="btn-row">
        <button class="btn-primary" id="btnStartStop">â–¶ Báº¯t Ä‘áº§u ghi nhiá»‡t Ä‘á»™</button>
        <button id="btnRead">READ â€“ Xem mÃ n hÃ¬nh káº¿ tiáº¿p</button>
        <button id="btnOk" class="btn-warning">OK â€“ XÃ¡c nháº­n bÃ¡o Ä‘á»™ng</button>
        <button id="btnReset">âŸ² Reset mÃ´ phá»ng</button>
      </div>
      <div class="note">
        Gá»£i Ã½: Nháº¥n <strong>READ</strong> nhiá»u láº§n Ä‘á»ƒ chuyá»ƒn qua: mÃ n chÃ­nh â†’ â€œHÃ´m nay (min/max)â€ â†’ â€œNgÃ y -1â€ â†’ â€œChi tiáº¿t alarmâ€.
        Há»c viÃªn pháº£i Ä‘á»c to Ä‘Æ°á»£c tá»«ng mÃ n hÃ¬nh.
      </div>
    </div>

    <!-- Ká»‹ch báº£n sá»‘c nhiá»‡t / sá»‘c láº¡nh -->
    <div class="grid-2">
      <div class="panel">
        <div class="panel-title">
          Ká»‹ch báº£n 1 â€“ TÄƒng nhiá»‡t &gt; 8Â°C
        </div>
        <div class="panel-desc">
          MÃ´ phá»ng tá»§ láº¡nh máº¥t láº¡nh (má»Ÿ cá»­a nhiá»u, máº¥t Ä‘iá»‡nâ€¦). Thiáº¿t bá»‹ sáº½ bÃ¡o <strong>ALARM HIGH</strong> náº¿u
          >8Â°C Ä‘á»§ lÃ¢u.
        </div>
        <div class="btn-row">
          <button id="btnScenarioWarm">ğŸ”¥ Báº¯t Ä‘áº§u sá»‘c nhiá»‡t (12Â°C)</button>
          <button id="btnTempUp">â–² TÄƒng 0,5Â°C</button>
          <button id="btnTempDown">â–¼ Giáº£m 0,5Â°C</button>
        </div>
        <div class="note">
          NgÆ°á»¡ng mÃ´ phá»ng: &gt;8Â°C liÃªn tá»¥c â‰¥ 3 giá» (180 phÃºt) â†’ ALARM HIGH.
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">Ká»‹ch báº£n 2 â€“ Nguy cÆ¡ Ä‘Ã´ng bÄƒng &lt; 2Â°C</div>
        <div class="panel-desc">
          MÃ´ phá»ng tá»§ láº¡nh quÃ¡ láº¡nh hoáº·c váº¯c xin sÃ¡t dÃ n láº¡nh. Thiáº¿t bá»‹ sáº½ bÃ¡o <strong>ALARM LOW</strong>
          náº¿u &lt;2Â°C Ä‘á»§ lÃ¢u.
        </div>
        <div class="btn-row">
          <button id="btnScenarioCold">â„ Sá»‘c láº¡nh (-3Â°C)</button>
        </div>
        <div class="note">
          NgÆ°á»¡ng mÃ´ phá»ng: &lt;2Â°C liÃªn tá»¥c â‰¥ 1 giá» (60 phÃºt) â†’ ALARM LOW.
        </div>
      </div>
    </div>

    <div class="note">
      LÆ°u Ã½: ÄÃ¢y lÃ  mÃ´ phá»ng dÃ¹ng cho táº­p huáº¥n, khÃ´ng thay tháº¿ thiáº¿t bá»‹ Fridge-tag 2E tháº­t. CÃ³ thá»ƒ chá»‰nh ngÆ°á»¡ng,
      thá»i gian bÃ¡o Ä‘á»™ng vÃ  thÃ´ng Ä‘iá»‡p phÃ¹ há»£p hÆ°á»›ng dáº«n quá»‘c gia / hÃ£ng sáº£n xuáº¥t.
    </div>
  </div>

  <script>
    // ===== Tham sá»‘ & biáº¿n mÃ´ phá»ng =====
    const HIGH_LIMIT = 8.0;
    const LOW_LIMIT = 2.0;
    const HIGH_ALARM_THRESHOLD = 180; // phÃºt
    const LOW_ALARM_THRESHOLD = 60;   // phÃºt
    const MIN_PER_TICK = 10;          // 1s = 10 phÃºt giáº£ láº­p
    const MIN_PER_DAY = 1440;         // 24 giá»

    let activated = false;
    let dateFormat = "dd.mm.yyyy";
    let simulatedDay = 1;
    let simulatedMonth = 1;
    let simulatedYear = 2025;

    let currentTemp = 5.0;
    let totalMinutes = 0;
    let highOorMinutes = 0;
    let lowOorMinutes = 0;

    let todayMinTemp = currentTemp;
    let todayMaxTemp = currentTemp;
    let todayHighOorTotal = 0;
    let todayLowOorTotal = 0;

    let yesterdayMinTemp = null;
    let yesterdayMaxTemp = null;
    let yesterdayHighOorTotal = 0;
    let yesterdayLowOorTotal = 0;

    let alarmHigh = false;
    let alarmLow = false;

    let lastAlarmType = null;       // "HIGH" | "LOW"
    let lastAlarmStartMinutes = 0;  // tÃ­nh tá»« lÃºc thiáº¿t bá»‹ cháº¡y
    let lastAlarmDurationMinutes = 0;
    let lastAlarmAcknowledged = false;

    let running = false;
    let intervalId = null;
    let screenMode = 0; // 0: main, 1: today, 2: yesterday, 3: last alarm

    // ===== DOM elements =====
    const overlayEl = document.getElementById("overlay");
    const tempEl = document.getElementById("tempValue");
    const totalTimeEl = document.getElementById("totalTime");
    const highOorEl = document.getElementById("highOor");
    const lowOorEl = document.getElementById("lowOor");
    const statusChipEl = document.getElementById("statusChip");
    const statusTextEl = document.getElementById("statusText");
    const alarmTextEl = document.getElementById("alarmText");
    const alarmBadgeEl = document.getElementById("alarmBadge");
    const screenTitleEl = document.getElementById("screenTitle");
    const historyTextEl = document.getElementById("historyText");
    const dateDisplayEl = document.getElementById("dateDisplay");
    const deviceEl = document.getElementById("device");

    const btnStartStop = document.getElementById("btnStartStop");
    const btnRead = document.getElementById("btnRead");
    const btnOk = document.getElementById("btnOk");
    const btnReset = document.getElementById("btnReset");
    const btnTempUp = document.getElementById("btnTempUp");
    const btnTempDown = document.getElementById("btnTempDown");
    const btnScenarioWarm = document.getElementById("btnScenarioWarm");
    const btnScenarioCold = document.getElementById("btnScenarioCold");
    const btnActivateDdMm = document.getElementById("btnActivateDdMm");
    const btnActivateMmDd = document.getElementById("btnActivateMmDd");

    // ===== Helper =====
    function pad(num) {
      return String(num).padStart(2, "0");
    }
    function formatMinutes(min) {
      const m = Math.floor(min);
      const hh = Math.floor(m / 60);
      const mm = m % 60;
      return `${pad(hh)}:${pad(mm)}`;
    }
    function formatDate(d, m, y) {
      if (dateFormat === "dd.mm.yyyy") {
        return `${pad(d)}.${pad(m)}.${y}`;
      } else {
        return `${pad(m)}.${pad(d)}.${y}`;
      }
    }

    function rollDayIfNeeded() {
      if (totalMinutes > 0 && totalMinutes % MIN_PER_DAY === 0) {
        // NgÃ y hÃ´m qua = hÃ´m nay
        yesterdayMinTemp = todayMinTemp;
        yesterdayMaxTemp = todayMaxTemp;
        yesterdayHighOorTotal = todayHighOorTotal;
        yesterdayLowOorTotal = todayLowOorTotal;

        // Reset hÃ´m nay
        todayMinTemp = currentTemp;
        todayMaxTemp = currentTemp;
        todayHighOorTotal = 0;
        todayLowOorTotal = 0;

        // Äá»•i ngÃ y giáº£ láº­p (ráº¥t Ä‘Æ¡n giáº£n, khÃ´ng cáº§n Ä‘Ãºng sá»‘ ngÃ y tá»«ng thÃ¡ng)
        simulatedDay += 1;
        if (simulatedDay > 30) {
          simulatedDay = 1;
          simulatedMonth += 1;
          if (simulatedMonth > 12) {
            simulatedMonth = 1;
            simulatedYear += 1;
          }
        }
      }
    }

    // ===== Cáº­p nháº­t mÃ n hÃ¬nh theo screenMode =====
    function updateScreenTexts() {
      let hasActiveAlarm = alarmHigh || alarmLow;

      // Máº·c Ä‘á»‹nh: chip & status
      if (hasActiveAlarm) {
        statusChipEl.textContent = "ALARM";
        statusChipEl.className = "status-chip status-alarm";
        deviceEl.classList.add("beating");
      } else if (lastAlarmType && lastAlarmAcknowledged) {
        statusChipEl.textContent = "OK (Ä‘Ã£ xÃ¡c nháº­n alarm)";
        statusChipEl.className = "status-chip status-muted";
        deviceEl.classList.remove("beating");
      } else {
        statusChipEl.textContent = "OK";
        statusChipEl.className = "status-chip status-ok";
        deviceEl.classList.remove("beating");
      }

      // Ná»™i dung theo tá»«ng mÃ n hÃ¬nh READ
      if (screenMode === 0) {
        // MÃ n hÃ¬nh chÃ­nh
        screenTitleEl.textContent = "MÃ n hÃ¬nh chÃ­nh â€“ Nhiá»‡t Ä‘á»™ hiá»‡n táº¡i";
        if (hasActiveAlarm) {
          if (alarmHigh) {
            statusTextEl.innerHTML =
              '<span style="color:#fecaca;">BÃO Äá»˜NG: Nhiá»‡t Ä‘á»™ cao kÃ©o dÃ i, náº±m ngoÃ i dáº£i 2â€“8Â°C.</span>';
          } else {
            statusTextEl.innerHTML =
              '<span style="color:#fee2e2;">BÃO Äá»˜NG: Nguy cÆ¡ Ä‘Ã´ng bÄƒng, nhiá»‡t Ä‘á»™ dÆ°á»›i 2Â°C.</span>';
          }
        } else {
          if (currentTemp >= LOW_LIMIT && currentTemp <= HIGH_LIMIT) {
            statusTextEl.innerHTML =
              '<span style="color:#bbf7d0;">Trong ngÆ°á»¡ng an toÃ n 2â€“8Â°C.</span>';
          } else if (currentTemp > HIGH_LIMIT) {
            statusTextEl.innerHTML =
              '<span style="color:#fed7aa;">Äang trÃªn 8Â°C â€“ cáº§n theo dÃµi vÃ  xá»­ trÃ­.</span>';
          } else {
            statusTextEl.innerHTML =
              '<span style="color:#fee2e2;">Äang dÆ°á»›i 2Â°C â€“ nguy cÆ¡ Ä‘Ã´ng bÄƒng váº¯c xin.</span>';
          }
        }

        if (hasActiveAlarm) {
          alarmBadgeEl.textContent = "ALARM";
          if (alarmHigh) {
            alarmTextEl.innerHTML =
              'ALARM HIGH: >8Â°C Ä‘á»§ lÃ¢u.<br><small>Há»c viÃªn mÃ´ táº£: cÃ¡ch ly váº¯c xin, ghi chÃ©p, bÃ¡o cÃ¡o, Ä‘Ã¡nh giÃ¡ sá»­ dá»¥ng.</small>';
          } else {
            alarmTextEl.innerHTML =
              'ALARM LOW: <2Â°C Ä‘á»§ lÃ¢u.<br><small>Há»c viÃªn mÃ´ táº£: kiá»ƒm tra Ä‘Ã´ng bÄƒng, Ä‘Ã¡nh giÃ¡ láº¡i lÃ´ váº¯c xin.</small>';
          }
        } else if (lastAlarmType && lastAlarmAcknowledged) {
          alarmBadgeEl.textContent = "ÄÃ£ xÃ¡c nháº­n";
          alarmTextEl.innerHTML =
            "KhÃ´ng cÃ³ bÃ¡o Ä‘á»™ng Ä‘ang hoáº¡t Ä‘á»™ng.<br><small>Váº«n cÃ³ thá»ƒ xem chi tiáº¿t láº§n bÃ¡o Ä‘á»™ng gáº§n nháº¥t báº±ng nÃºt READ.</small>";
        } else {
          alarmBadgeEl.textContent = "KhÃ´ng cÃ³";
          alarmTextEl.textContent =
            'KhÃ´ng cÃ³ bÃ¡o Ä‘á»™ng. Há»c viÃªn Ä‘á»c: "OK, nhiá»‡t Ä‘á»™ hiá»‡n táº¡i ... Â°C, trong dáº£i an toÃ n hoáº·c khÃ´ng".';
        }

        historyTextEl.innerHTML =
          "Báº¥m READ Ä‘á»ƒ xem lá»‹ch sá»­:<br>â€“ HÃ´m nay: min / max, cÃ³ alarm khÃ´ng<br>â€“ NgÃ y -1<br>â€“ Chi tiáº¿t alarm gáº§n nháº¥t.";
      } else if (screenMode === 1) {
        // HÃ´m nay
        screenTitleEl.textContent = "MÃ n hÃ¬nh READ â€“ HÃ´m nay (Day 0)";
        let text = `HÃ´m nay â€“ min: <strong>${todayMinTemp.toFixed(
          1
        )}Â°C</strong>, max: <strong>${todayMaxTemp.toFixed(
          1
        )}Â°C</strong>.`;
        if (todayHighOorTotal > 0 || todayLowOorTotal > 0) {
          text += `<br>CÃ³ thá»i gian ngoÃ i ngÆ°á»¡ng: `;
          if (todayHighOorTotal > 0)
            text += `&gt;8Â°C: <strong>${Math.round(
              todayHighOorTotal
            )} phÃºt</strong>. `;
          if (todayLowOorTotal > 0)
            text += `&lt;2Â°C: <strong>${Math.round(
              todayLowOorTotal
            )} phÃºt</strong>.`;
        } else {
          text += "<br>KhÃ´ng cÃ³ thá»i gian ngoÃ i dáº£i 2â€“8Â°C hÃ´m nay.";
        }
        historyTextEl.innerHTML = text;

        statusTextEl.innerHTML =
          '<span style="color:#e5e7eb;">MÃ n hÃ¬nh lá»‹ch sá»­ â€“ hÃ´m nay. Há»c viÃªn Ä‘á»c to min/max vÃ  cÃ³/khÃ´ng cÃ³ thá»i gian ngoÃ i ngÆ°á»¡ng.</span>';
        alarmBadgeEl.textContent = "READ";
        alarmTextEl.textContent =
          "ÄÃ¢y lÃ  mÃ n hÃ¬nh lá»‹ch sá»­ ngÃ y 0 (hÃ´m nay) â€“ dÃ¹ng Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ tá»§ láº¡nh cáº£ ngÃ y.";
      } else if (screenMode === 2) {
        // NgÃ y -1
        screenTitleEl.textContent = "MÃ n hÃ¬nh READ â€“ NgÃ y -1";
        if (yesterdayMinTemp === null) {
          historyTextEl.innerHTML =
            "ChÆ°a cÃ³ dá»¯ liá»‡u ngÃ y -1 (thiáº¿t bá»‹ chÆ°a cháº¡y Ä‘á»§ 24 giá»).";
        } else {
          let text = `NgÃ y -1 â€“ min: <strong>${yesterdayMinTemp.toFixed(
            1
          )}Â°C</strong>, max: <strong>${yesterdayMaxTemp.toFixed(
            1
          )}Â°C</strong>.`;
          if (yesterdayHighOorTotal > 0 || yesterdayLowOorTotal > 0) {
            text += `<br>CÃ³ thá»i gian ngoÃ i ngÆ°á»¡ng: `;
            if (yesterdayHighOorTotal > 0)
              text += `&gt;8Â°C: <strong>${Math.round(
                yesterdayHighOorTotal
              )} phÃºt</strong>. `;
            if (yesterdayLowOorTotal > 0)
              text += `&lt;2Â°C: <strong>${Math.round(
                yesterdayLowOorTotal
              )} phÃºt</strong>.`;
          } else {
            text += "<br>KhÃ´ng cÃ³ thá»i gian ngoÃ i dáº£i 2â€“8Â°C ngÃ y -1.";
          }
          historyTextEl.innerHTML = text;
        }
        statusTextEl.innerHTML =
          '<span style="color:#e5e7eb;">MÃ n hÃ¬nh lá»‹ch sá»­ â€“ ngÃ y -1. Há»c viÃªn mÃ´ táº£ á»•n Ä‘á»‹nh/khÃ´ng á»•n Ä‘á»‹nh cá»§a tá»§ láº¡nh.</span>';
        alarmBadgeEl.textContent = "READ";
        alarmTextEl.textContent =
          "DÃ¹ng Ä‘á»ƒ kiá»ƒm tra láº¡i hoáº¡t Ä‘á»™ng tá»§ láº¡nh cá»§a ngÃ y liá»n trÆ°á»›c.";
      } else if (screenMode === 3) {
        // Chi tiáº¿t alarm
        screenTitleEl.textContent = "MÃ n hÃ¬nh READ â€“ Chi tiáº¿t alarm gáº§n nháº¥t";
        if (!lastAlarmType) {
          historyTextEl.innerHTML =
            "ChÆ°a tá»«ng cÃ³ láº§n bÃ¡o Ä‘á»™ng nÃ o Ä‘Æ°á»£c ghi nháº­n trong mÃ´ phá»ng nÃ y.";
          alarmBadgeEl.textContent = "KhÃ´ng cÃ³";
          alarmTextEl.textContent =
            "KhÃ´ng cÃ³ thÃ´ng tin vá» alarm. Náº¿u táº¡o sá»‘c nhiá»‡t/sá»‘c láº¡nh Ä‘á»§ lÃ¢u, sáº½ cÃ³ láº§n bÃ¡o Ä‘á»™ng Ä‘áº§u tiÃªn Ä‘á»ƒ xem.";
        } else {
          const startTimeStr = formatMinutes(lastAlarmStartMinutes);
          const durationStr = Math.round(lastAlarmDurationMinutes);
          const typeText =
            lastAlarmType === "HIGH" ? "ALARM HIGH (>8Â°C)" : "ALARM LOW (<2Â°C)";
          historyTextEl.innerHTML =
            `Loáº¡i: <strong>${typeText}</strong><br>` +
            `Thá»i Ä‘iá»ƒm báº¯t Ä‘áº§u vÆ°á»£t ngÆ°á»¡ng (giáº£ láº­p): <strong>${startTimeStr}</strong> (ká»ƒ tá»« khi cháº¡y).<br>` +
            `Thá»i lÆ°á»£ng ngoÃ i ngÆ°á»¡ng dÃ¹ng Ä‘á»ƒ kÃ­ch hoáº¡t alarm: <strong>${durationStr} phÃºt</strong>.<br>` +
            `<small>Há»c viÃªn tháº£o luáº­n: vá»›i thá»i gian phÆ¡i nhiá»…m nhÆ° váº­y, váº¯c xin cÃ³ Ä‘Æ°á»£c phÃ©p tiáº¿p tá»¥c sá»­ dá»¥ng khÃ´ng theo hÆ°á»›ng dáº«n quá»‘c gia?</small>`;
          alarmBadgeEl.textContent = lastAlarmAcknowledged
            ? "Alarm Ä‘Ã£ xÃ¡c nháº­n"
            : "Alarm gáº§n nháº¥t";
          alarmTextEl.textContent =
            "MÃ n hÃ¬nh nÃ y mÃ´ phá»ng cÃ¡c thÃ´ng tin alarm mÃ  Fridge-tag 2E hiá»ƒn thá»‹ Ä‘á»ƒ quyáº¿t Ä‘á»‹nh xá»­ trÃ­ lÃ´ váº¯c xin.";
        }
        statusTextEl.innerHTML =
          '<span style="color:#e5e7eb;">MÃ n hÃ¬nh chi tiáº¿t alarm gáº§n nháº¥t â€“ dÃ¹ng Ä‘á»ƒ hÆ°á»›ng dáº«n cÃ¡ch Ä‘á»c vÃ  ghi chÃ©p.</span>';
      }
    }

    function updateDisplay() {
      tempEl.textContent = currentTemp.toFixed(1);
      totalTimeEl.textContent = formatMinutes(totalMinutes);
      highOorEl.textContent = `${Math.round(highOorMinutes)} phÃºt`;
      lowOorEl.textContent = `${Math.round(lowOorMinutes)} phÃºt`;
      dateDisplayEl.textContent = formatDate(
        simulatedDay,
        simulatedMonth,
        simulatedYear
      );
      updateScreenTexts();
    }

    // ===== Tick mÃ´ phá»ng =====
    function tick() {
      if (!activated) return;
      totalMinutes += MIN_PER_TICK;

      // Cáº­p nháº­t today min/max
      todayMinTemp = Math.min(todayMinTemp, currentTemp);
      todayMaxTemp = Math.max(todayMaxTemp, currentTemp);

      // Theo dÃµi phÆ¡i nhiá»…m
      if (currentTemp > HIGH_LIMIT) {
        highOorMinutes += MIN_PER_TICK;
        todayHighOorTotal += MIN_PER_TICK;
        lowOorMinutes = 0;
      } else if (currentTemp < LOW_LIMIT) {
        lowOorMinutes += MIN_PER_TICK;
        todayLowOorTotal += MIN_PER_TICK;
        highOorMinutes = 0;
      } else {
        highOorMinutes = 0;
        lowOorMinutes = 0;
      }

      // KÃ­ch hoáº¡t alarm HIGH
      if (highOorMinutes >= HIGH_ALARM_THRESHOLD) {
        if (!alarmHigh) {
          alarmHigh = true;
          lastAlarmType = "HIGH";
          lastAlarmStartMinutes = totalMinutes - highOorMinutes;
          lastAlarmAcknowledged = false;
        }
        lastAlarmDurationMinutes = highOorMinutes;
      }

      // KÃ­ch hoáº¡t alarm LOW
      if (lowOorMinutes >= LOW_ALARM_THRESHOLD) {
        if (!alarmLow) {
          alarmLow = true;
          lastAlarmType = "LOW";
          lastAlarmStartMinutes = totalMinutes - lowOorMinutes;
          lastAlarmAcknowledged = false;
        }
        lastAlarmDurationMinutes = lowOorMinutes;
      }

      rollDayIfNeeded();
      updateDisplay();
    }

    // ===== Äiá»u khiá»ƒn =====
    function start() {
      if (!activated) {
        alert("HÃ£y kÃ­ch hoáº¡t thiáº¿t bá»‹ (SET + READ) trÆ°á»›c khi báº¯t Ä‘áº§u.");
        return;
      }
      if (running) return;
      running = true;
      btnStartStop.textContent = "â¸ Táº¡m dá»«ng ghi nhiá»‡t Ä‘á»™";
      intervalId = setInterval(tick, 1000);
    }

    function stop() {
      running = false;
      btnStartStop.textContent = "â–¶ Tiáº¿p tá»¥c ghi nhiá»‡t Ä‘á»™";
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
      }
    }

    function resetAll() {
      stop();
      activated = false;
      screenMode = 0;

      currentTemp = 5.0;
      totalMinutes = 0;
      highOorMinutes = 0;
      lowOorMinutes = 0;

      todayMinTemp = currentTemp;
      todayMaxTemp = currentTemp;
      todayHighOorTotal = 0;
      todayLowOorTotal = 0;

      yesterdayMinTemp = null;
      yesterdayMaxTemp = null;
      yesterdayHighOorTotal = 0;
      yesterdayLowOorTotal = 0;

      alarmHigh = false;
      alarmLow = false;
      lastAlarmType = null;
      lastAlarmStartMinutes = 0;
      lastAlarmDurationMinutes = 0;
      lastAlarmAcknowledged = false;

      simulatedDay = 1;
      simulatedMonth = 1;
      simulatedYear = 2025;

      btnStartStop.textContent = "â–¶ Báº¯t Ä‘áº§u ghi nhiá»‡t Ä‘á»™";
      overlayEl.style.display = "flex";
      deviceEl.classList.remove("beating");
      updateDisplay();
    }

    // ===== Event listeners =====
    btnStartStop.addEventListener("click", () => {
      if (running) {
        stop();
      } else {
        start();
      }
    });

    btnRead.addEventListener("click", () => {
      if (!activated) {
        alert("HÃ£y kÃ­ch hoáº¡t thiáº¿t bá»‹ (SET + READ) trÆ°á»›c.");
        return;
      }
      screenMode = (screenMode + 1) % 4;
      updateDisplay();
    });

    btnOk.addEventListener("click", () => {
      if (!activated) {
        alert("Thiáº¿t bá»‹ chÆ°a kÃ­ch hoáº¡t.");
        return;
      }
      if (!alarmHigh && !alarmLow && !lastAlarmType) {
        alert(
          "ChÆ°a cÃ³ alarm nÃ o trong mÃ´ phá»ng. HÃ£y táº¡o ká»‹ch báº£n sá»‘c nhiá»‡t/sá»‘c láº¡nh trÆ°á»›c."
        );
        return;
      }
      // Giá»‘ng nháº¥n OK: xÃ¡c nháº­n alarm, xÃ³a tráº¡ng thÃ¡i alarm Ä‘ang hoáº¡t Ä‘á»™ng
      alarmHigh = false;
      alarmLow = false;
      highOorMinutes = 0;
      lowOorMinutes = 0;
      lastAlarmAcknowledged = true;
      updateDisplay();
      alert(
        "Giáº£ Ä‘á»‹nh: Anh/chá»‹ Ä‘Ã£ ghi chÃ©p, cÃ¡ch ly váº¯c xin, bÃ¡o cÃ¡oâ€¦ Sau Ä‘Ã³ má»›i nháº¥n OK Ä‘á»ƒ xÃ¡c nháº­n bÃ¡o Ä‘á»™ng."
      );
    });

    btnReset.addEventListener("click", () => {
      resetAll();
    });

    btnTempUp.addEventListener("click", () => {
      currentTemp += 0.5;
      updateDisplay();
    });

    btnTempDown.addEventListener("click", () => {
      currentTemp -= 0.5;
      updateDisplay();
    });

    btnScenarioWarm.addEventListener("click", () => {
      if (!activated) {
        alert("HÃ£y kÃ­ch hoáº¡t thiáº¿t bá»‹ (SET + READ) trÆ°á»›c.");
        return;
      }
      currentTemp = 12.0;
      updateDisplay();
    });

    btnScenarioCold.addEventListener("click", () => {
      if (!activated) {
        alert("HÃ£y kÃ­ch hoáº¡t thiáº¿t bá»‹ (SET + READ) trÆ°á»›c.");
        return;
      }
      currentTemp = -3.0;
      updateDisplay();
    });

    // KÃ­ch hoáº¡t mÃ´ phá»ng SET+READ vÃ  chá»n format ngÃ y
    function activate(format) {
      dateFormat = format;
      activated = true;
      overlayEl.style.display = "none";
      simulatedDay = 1;
      simulatedMonth = 1;
      simulatedYear = 2025;
      totalMinutes = 0;
      todayMinTemp = currentTemp;
      todayMaxTemp = currentTemp;
      todayHighOorTotal = 0;
      todayLowOorTotal = 0;
      updateDisplay();
    }

    btnActivateDdMm.addEventListener("click", () => {
      activate("dd.mm.yyyy");
    });
    btnActivateMmDd.addEventListener("click", () => {
      activate("mm.dd.yyyy");
    });

    // Khá»Ÿi táº¡o
    updateDisplay();
  </script>
</body>
</html>
