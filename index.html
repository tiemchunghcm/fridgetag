<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mô phỏng Fridge-Tag 2E</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            flex-direction: column;
        }
        .device {
            width: 128px;
            height: 75px;
            background-color: #333;
            border: 2px solid #000;
            border-radius: 5px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .screen {
            width: 95px;
            height: 27px;
            background-color: #000;
            color: #0f0; /* Green LCD color */
            font-family: 'Courier New', monospace;
            font-size: 8px;
            line-height: 1.2;
            padding: 2px;
            margin: 0 auto;
            border: 1px solid #333;
            overflow: hidden;
            white-space: pre;
            text-align: center;
        }
        .buttons {
            display: flex;
            justify-content: space-around;
            padding: 0 5px;
        }
        button {
            width: 40px;
            height: 15px;
            background-color: #666;
            color: white;
            border: none;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
        }
        button:active {
            background-color: #999;
        }
        .instructions {
            margin-top: 20px;
            text-align: center;
            max-width: 600px;
        }
        .icons {
            display: inline-block;
            width: 8px;
            height: 8px;
        }
        .ok { color: #0f0; } /* Green check */
        .alarm { color: #f00; } /* Red X */
        .battery-full { content: "███"; color: #0f0; }
        .battery-med { content: "██ "; color: #ff0; }
        .battery-low { content: "█  "; color: #f00; }
        .arrow-up { content: "▲"; color: #f00; }
        .arrow-down { content: "▼"; color: #f00; }
        .warning { content: "!"; color: #f00; }
    </style>
</head>
<body>
    <div class="device">
        <div id="screen" class="screen"></div>
        <div class="buttons">
            <button id="setBtn">SET</button>
            <button id="readBtn">READ</button>
        </div>
    </div>
    <div class="instructions">
        <h3>Hướng dẫn sử dụng mô phỏng Fridge-Tag 2E</h3>
        <ul>
            <li><strong>Kích hoạt lần đầu:</strong> Click cả hai nút SET và READ gần như đồng thời (trong vòng 1 giây). Chọn định dạng ngày bằng cách click READ để chuyển (dd.mm.yyyy hoặc mm.dd.yyyy), sau đó SET để xác nhận. Tiếp tục set ngày, giờ, và giới hạn báo động.</li>
            <li><strong>Xem nhiệt độ hiện tại & lịch sử:</strong> Sau kích hoạt, màn hình hiển thị nhiệt độ hiện tại. Click READ để xem hôm nay (min/max), click tiếp để xem ngày -1 (hôm qua).</li>
            <li><strong>Xem & xử trí cảnh báo:</strong> Nếu có báo động (giả lập ngẫu nhiên), màn hình hiển thị ALARM HIGH/LOW. Click READ để xem chi tiết (thời gian, thời lượng). Không thể reset, chỉ xem.</li>
            <li>Lưu ý: Đây là mô phỏng đơn giản dựa trên manual thực tế. Nhiệt độ giả lập thay đổi nhẹ theo thời gian.</li>
        </ul>
    </div>

    <script>
        class FridgeTagSimulator {
            constructor() {
                this.screen = document.getElementById('screen');
                this.setBtn = document.getElementById('setBtn');
                this.readBtn = document.getElementById('readBtn');
                this.state = 'sleep'; // sleep, activation, normal, history_today, history_yesterday, alarm_high, alarm_low, alarm_detail
                this.dateFormat = 'dd.mm.yyyy'; // or 'mm.dd.yyyy'
                this.currentDate = new Date('2025-12-05T12:00:00'); // Current date
                this.currentTemp = 4.2; // °C
                this.todayMin = 2.5;
                this.todayMax = 5.8;
                this.yesterdayMin = 1.8;
                this.yesterdayMax = 6.2;
                this.alarmHigh = false;
                this.alarmLow = false;
                this.highLimit = 8.0;
                this.lowLimit = 0.5;
                this.alarmDuration = '00:15';
                this.alarmTime = '10:30';
                this.activationStep = 0; // 0: format, 1: day, 2: month, 3: year, 4: hour, 5: min, 6: high limit, 7: low limit
                this.currentValue = 0;
                this.lastSetTime = 0;
                this.lastReadTime = 0;

                this.setBtn.addEventListener('click', () => this.handleSet());
                this.readBtn.addEventListener('click', () => this.handleRead());
                this.simulateTemp();
                this.updateScreen();
            }

            handleSet() {
                this.lastSetTime = Date.now();
                if (this.state === 'sleep') {
                    // Need both for activation
                    return;
                }
                if (this.state === 'activation') {
                    this.confirmActivationStep();
                } else if (this.state === 'normal' || this.state === 'history_today' || this.state === 'history_yesterday') {
                    // Enter menu, but simplify
                    this.state = 'activation';
                    this.activationStep = 0;
                } else {
                    this.state = 'normal';
                }
                this.updateScreen();
            }

            handleRead() {
                this.lastReadTime = Date.now();
                if (this.state === 'sleep' && Math.abs(this.lastSetTime - Date.now()) < 1000) {
                    // Both pressed within 1s
                    this.state = 'activation';
                    this.activationStep = 0;
                    this.updateScreen();
                    return;
                }
                if (this.state === 'sleep') {
                    // Single read in sleep: test display
                    this.screen.textContent = 'TEST OK';
                    setTimeout(() => this.updateScreen(), 2000);
                    return;
                }
                if (this.state === 'activation') {
                    this.adjustActivationStep();
                } else if (this.state === 'normal') {
                    this.state = 'history_today';
                } else if (this.state === 'history_today') {
                    this.state = 'history_yesterday';
                } else if (this.state === 'history_yesterday') {
                    this.state = 'normal';
                } else if (this.state.startsWith('alarm_')) {
                    // View details
                    if (this.state === 'alarm_high' || this.state === 'alarm_low') {
                        this.state += '_detail';
                    } else {
                        this.state = 'normal'; // Back
                    }
                }
                this.updateScreen();
            }

            confirmActivationStep() {
                switch (this.activationStep) {
                    case 0: // Format
                        this.activationStep = 1;
                        this.currentValue = parseInt(this.currentDate.getDate().toString().padStart(2, '0'));
                        break;
                    case 1: // Day
                        this.currentDate.setDate(this.currentValue);
                        this.activationStep = 2;
                        this.currentValue = this.currentDate.getMonth() + 1;
                        break;
                    case 2: // Month
                        this.currentDate.setMonth(this.currentValue - 1);
                        this.activationStep = 3;
                        this.currentValue = this.currentDate.getFullYear() % 100; // Last two digits
                        break;
                    case 3: // Year
                        this.currentDate.setFullYear(2000 + this.currentValue);
                        this.activationStep = 4;
                        this.currentValue = this.currentDate.getHours();
                        break;
                    case 4: // Hour
                        this.currentDate.setHours(this.currentValue);
                        this.activationStep = 5;
                        this.currentValue = this.currentDate.getMinutes();
                        break;
                    case 5: // Min
                        this.currentDate.setMinutes(this.currentValue);
                        this.activationStep = 6;
                        this.currentValue = this.highLimit * 10; // For adjustment
                        break;
                    case 6: // High limit
                        this.highLimit = this.currentValue / 10;
                        this.activationStep = 7;
                        this.currentValue = this.lowLimit * 10;
                        break;
                    case 7: // Low limit
                        this.lowLimit = this.currentValue / 10;
                        this.state = 'normal';
                        this.activationStep = 0;
                        this.simulateAlarms();
                        break;
                }
            }

            adjustActivationStep() {
                switch (this.activationStep) {
                    case 0: // Toggle format
                        this.dateFormat = this.dateFormat === 'dd.mm.yyyy' ? 'mm.dd.yyyy' : 'dd.mm.yyyy';
                        break;
                    case 1: case 2: case 3: case 4: case 5:
                        this.currentValue = (this.currentValue % (this.activationStep <=2 ? 31 : 24)) + 1; // Rough cycle
                        break;
                    case 6: case 7:
                        this.currentValue = (this.currentValue + 1) % 701; // -70 to +70 *10
                        break;
                }
            }

            updateScreen() {
                let display = '';
                const now = new Date();
                const day = now.getDate().toString().padStart(2, '0');
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const year = now.getFullYear().toString().slice(-2);
                const hours = now.getHours().toString().padStart(2, '0');
                const mins = now.getMinutes().toString().padStart(2, '0');
                const tempStr = this.currentTemp.toFixed(1) + ' °C';

                switch (this.state) {
                    case 'sleep':
                        display = ''; // Blank
                        break;
                    case 'activation':
                        display = 'ACTIVATE\nFORMAT: ' + this.dateFormat;
                        if (this.activationStep > 0) {
                            let valStr = this.currentValue.toString().padStart(2, '0');
                            if (this.activationStep >=6) valStr = (this.currentValue / 10).toFixed(1);
                            display += '\n' + ['DAY:', 'MONTH:', 'YEAR:', 'HOUR:', 'MIN:', 'HIGH LIM:', 'LOW LIM:'][this.activationStep-1] + ' ' + valStr;
                        }
                        break;
                    case 'normal':
                        display = (this.alarmHigh || this.alarmLow ? 'X ' : 'OK ') + tempStr + '\n' + hours + ':' + mins + ' ' + day + '.' + month + '.' + year.slice(-2);
                        display += '\nInt.Sensor °C'; // Battery simplified
                        break;
                    case 'history_today':
                        display = 'TODAY\nMIN ' + this.todayMin.toFixed(1) + ' MAX ' + this.todayMax.toFixed(1) + '\n00:00';
                        break;
                    case 'history_yesterday':
                        display = 'YEST (-1d)\nMIN ' + this.yesterdayMin.toFixed(1) + ' MAX ' + this.yesterdayMax.toFixed(1) + '\n00:00';
                        break;
                    case 'alarm_high':
                        display = 'X ALARM HIGH\nMAX ' + this.todayMax.toFixed(1) + ' !\n' + this.alarmDuration;
                        break;
                    case 'alarm_low':
                        display = 'X ALARM LOW\nMIN ' + this.todayMin.toFixed(1) + ' !\n' + this.alarmDuration;
                        break;
                    case 'alarm_high_detail':
                        display = 'HIGH ' + this.alarmTime + '\nTEMP ' + this.todayMax.toFixed(1) + '\nDUR ' + this.alarmDuration;
                        break;
                    case 'alarm_low_detail':
                        display = 'LOW ' + this.alarmTime + '\nTEMP ' + this.todayMin.toFixed(1) + '\nDUR ' + this.alarmDuration;
                        break;
                }
                this.screen.textContent = display;
            }

            simulateTemp() {
                // Simulate temp change every 30s
                setInterval(() => {
                    this.currentTemp += (Math.random() - 0.5) * 0.5;
                    this.currentTemp = Math.max(-10, Math.min(55, this.currentTemp));
                    this.simulateAlarms();
                    if (this.state === 'normal') this.updateScreen();
                }, 30000);
            }

            simulateAlarms() {
                this.alarmHigh = this.currentTemp > this.highLimit;
                this.alarmLow = this.currentTemp < this.lowLimit;
                if (this.alarmHigh || this.alarmLow) {
                    if (this.state === 'normal') {
                        this.state = this.alarmHigh ? 'alarm_high' : 'alarm_low';
                    }
                }
            }
        }

        new FridgeTagSimulator();
    </script>
</body>
</html>
